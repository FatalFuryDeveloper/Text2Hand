<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Demo Fuentes Personalizadas con IndexedDB + FontFace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #374151;
    }
    html, body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
      margin: 0;
      padding: 0;
    }
    .wrap {
      max-width: 980px; margin: 40px auto; padding: 0 20px;
    }
    h1 { margin: 0 0 10px; font-size: 26px; }
    p  { color: var(--muted); margin-top: 6px; }
    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }
    .card h2 { margin: 0 0 12px; font-size: 18px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input[type="file"] {
      padding: 10px; border: 1px dashed var(--border); border-radius: 10px; background: transparent; color: var(--text);
    }
    button, select {
      background: #1f2937; border: 1px solid var(--border); color: var(--text);
      padding: 10px 14px; border-radius: 10px; cursor: pointer;
    }
    button.primary { background: var(--accent); border-color: transparent; color: #03210d; font-weight: 700; }
    button.danger  { background: var(--danger); border-color: transparent; color: #2a0a0a; font-weight: 700; }
    .list { margin-top: 10px; border-top: 1px dashed var(--border); padding-top: 10px; }
    .item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;
      background: #0b1220;
    }
    .muted { color: var(--muted); font-size: 12px; }
    .preview {
      min-height: 280px;
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      line-height: 1.6;
    }
    code.kbd {
      background: #0b1220; border: 1px solid var(--border); padding: 3px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .small { font-size: 12px; color: var(--muted); }
    .spacer { height: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Demo: Guardar & Usar Fuentes Personalizadas</h1>
    <p>Sube archivos <code class="kbd">.ttf</code>, <code class="kbd">.otf</code>, <code class="kbd">.woff</code> o <code class="kbd">.woff2</code>. Se guardan en <b>IndexedDB</b> y se registran con <b>FontFace API</b>.</p>

    <div class="grid">
      <!-- Panel izquierdo: carga y listado -->
      <div class="card">
        <h2>1) Subir fuente a IndexedDB</h2>
        <div class="row">
          <input id="fontFile" type="file" accept=".ttf,.otf,.woff,.woff2" />
          <button id="btnUpload" class="primary">Guardar + Registrar</button>
        </div>
        <div class="spacer"></div>
        <div class="small">Consejo: nombra tus archivos con el nombre de la familia (ej. <i>MiFuente-Regular.ttf</i>). El demo normaliza espacios y mayúsculas.</div>

        <div class="list" id="list">
          <h2>2) Fuentes guardadas</h2>
          <div id="items"></div>
          <div class="muted" id="emptyMsg" style="display:none">No hay fuentes guardadas aún.</div>
        </div>
      </div>

      <!-- Panel derecho: vista previa -->
      <div class="card">
        <h2>3) Vista previa / aplicar fuente</h2>
        <div class="row">
          <label for="selectFont">Fuente:</label>
          <select id="selectFont"></select>
          <button id="btnApply">Aplicar</button>
        </div>
        <div class="spacer"></div>
        <div id="preview" class="preview" contenteditable="true">
          Escribe aquí para probar tu fuente…<br>
          0123456789 áéíóú ñ Ñ ¡! ¿? — “quotes”<br>
          The quick brown fox jumps over the lazy dog.
        </div>
        <div class="spacer"></div>
        <div class="small">La selección aplica al cuadro de arriba usando <b>font-family</b> CSS.</div>
      </div>
    </div>

    <p class="small">No se usan librerías externas. Funciona en navegadores modernos. Borrar datos desde aquí elimina la fuente de IndexedDB de esta app (no del sistema).</p>
  </div>

  <script>
/* =========================
   Configuración IndexedDB
   ========================= */
const DB_NAME    = 'text2hand-fonts-db';
const STORE_NAME = 'fonts';
const DB_VERSION = 1;

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        store.createIndex('byName', 'name', { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror   = () => reject(req.error);
  });
}

async function saveFont({ id, name, format, blob }) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).put({ id, name, format, blob });
    tx.oncomplete = () => resolve(id);
    tx.onerror    = () => reject(tx.error);
  });
}



async function getAllFonts() {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const req = tx.objectStore(STORE_NAME).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror   = () => reject(req.error);
  });
}

async function deleteFont(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).delete(id);
    tx.oncomplete = () => resolve();
    tx.onerror    = () => reject(tx.error);
  });
}

/* =========================
   Registro de fuentes (FontFace)
   ========================= */
function guessFormatFromExt(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  if (ext === 'woff2') return 'woff2';
  if (ext === 'woff')  return 'woff';
  if (ext === 'otf')   return 'opentype';
  return 'truetype'; // por defecto para .ttf
}

function slugifyName(name) {
  return name
    .replace(/\.(ttf|otf|woff2|woff)$/i, '')
    .replace(/[^a-z0-9]+/gi, ' ')
    .trim()
    .replace(/\s+/g, '');
}

async function registerFontFromBlob({ blob, family, format }) {
  const url = URL.createObjectURL(blob);
  const src = `url(${url}) format('${format}')`;
  const fontFace = new FontFace(family, src);
  await fontFace.load();
  document.fonts.add(fontFace);
  // Nota: si revocas el ObjectURL aquí, puede dejar de estar disponible.
  // Déjalo vivo durante la sesión. En apps reales podrías recrearlo cuando se necesite.
  return fontFace;
}

/* =========================
   Estado simple para la demo
   ========================= */
const vm = {
  fonts: [], // [{id, name, format, isCustom}]
  selected: null
};

const $file   = document.getElementById('fontFile');
const $upload = document.getElementById('btnUpload');
const $items  = document.getElementById('items');
const $empty  = document.getElementById('emptyMsg');
const $select = document.getElementById('selectFont');
const $apply  = document.getElementById('btnApply');
const $prev   = document.getElementById('preview');

/* =========================
   Render helpers
   ========================= */
function renderList() {
  $items.innerHTML = '';
  if (!vm.fonts.length) {
    $empty.style.display = '';
    return;
  }
  $empty.style.display = 'none';
  vm.fonts.forEach(item => {
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div>
        <div><b>${item.name}</b> <span class="muted">(${item.format})</span></div>
        <div class="muted">${item.id}</div>
      </div>
      <div class="row">
        <button data-apply="${item.id}">Aplicar</button>
        <button class="danger" data-del="${item.id}">Borrar</button>
      </div>
    `;
    $items.appendChild(row);
  });
}

function renderSelect() {
  const opts = [
    `<option value="">(elige una fuente)</option>`,
    ...vm.fonts.map(f => `<option value="${f.id}">${f.name}</option>`)
  ];
  $select.innerHTML = opts.join('');
}

/* =========================
   Acciones UI
   ========================= */
async function bootLoadCustomFonts() {
  const all = await getAllFonts();
  vm.fonts = [];
  for (const item of all) {
    try {
      await registerFontFromBlob({
        blob: item.blob,
        family: item.name,
        format: item.format
      });
      vm.fonts.push({ id: item.id, name: item.name, format: item.format, isCustom: true });
    } catch (e) {
      console.warn('No se pudo registrar la fuente', item.name, e);
    }
  }
  renderList();
  renderSelect();
}

async function handleUpload() {
  const file = $file.files?.[0];
  if (!file) {
    alert('Selecciona un archivo de fuente primero.');
    return;
  }
  const family = slugifyName(file.name);
  const id = `custom:${family}`;
  const format = guessFormatFromExt(file.name);

  await saveFont({ id, name: family, format, blob: file });
  await registerFontFromBlob({ blob: file, family, format });

  const existsIdx = vm.fonts.findIndex(f => f.id === id);
  const record = { id, name: family, format, isCustom: true };
  if (existsIdx >= 0) vm.fonts[existsIdx] = record; else vm.fonts.push(record);

  renderList();
  renderSelect();
  $select.value = id;
  applyFont(id);
  $file.value = '';
}

async function applyFont(id) {
  const item = vm.fonts.find(f => f.id === id);
  if (!item) return;
  vm.selected = id;
  const family = item.name;
  $prev.style.fontFamily = `"${family}", sans-serif`;
}

async function removeFont(id) {
  await deleteFont(id);
  // No hay “unregister” estándar; simplemente la quitamos de la UI.
  vm.fonts = vm.fonts.filter(f => f.id !== id);
  renderList();
  renderSelect();
  if (vm.selected === id) {
    vm.selected = null;
    $prev.style.fontFamily = '';
  }
}

/* =========================
   Eventos
   ========================= */
$upload.addEventListener('click', handleUpload);

$items.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const applyId = btn.getAttribute('data-apply');
  const delId   = btn.getAttribute('data-del');
  if (applyId) applyFont(applyId);
  if (delId) {
    const ok = confirm('¿Eliminar esta fuente de IndexedDB?');
    if (ok) removeFont(delId);
  }
});

$apply.addEventListener('click', () => {
  const id = $select.value;
  if (id) applyFont(id);
});

/* =========================
   Arranque
   ========================= */
bootLoadCustomFonts();
  </script>
</body>
</html>